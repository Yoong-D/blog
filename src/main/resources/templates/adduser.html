<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
<!--아이디, 암호, 암호 확인, 이름, 이메일 회원 가입 -->
<form action="/userreg" method="post" id="addUser">
<!--<form action="adduser" method="get" id="addUser">-->

    <fieldset>
        <legend>회원 가입</legend>
        <label for="username">아이디</label>
        <input placeholder="아이디를 입력해주세요." type="text" id="username" name="username" required><br>
        <label for="password">암호</label>
        <input placeholder="비밀번호를 입력해주세요." type="password" id="password" name="password" required><br>
        <label for="again_password">암호 확인</label>
        <input placeholder="비밀번호를 다시 입력해주세요." type="password" id="again_password" name="again_password" required><br>
        <label for="name">이름</label>
        <input placeholder="사용할 이름을 입력해주세요." type="text" id="name" name="name" required><br>
        <label for="email">이메일</label>
        <input placeholder="이메일을 입력해주세요." type="email" id="email" name="email" required><br><br>
        <input type="hidden" value = " " name="error" id="errormessage">
        <input type="submit" value="회원가입" id="submit">
    </fieldset>
</form>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const submitButton = document.getElementById('submit');
        const form = document.getElementById('addUser');

        submitButton.addEventListener('click', function (event) {
            event.preventDefault(); // 기본 제출 동작을 막음

            let username = document.getElementById('username').value;
            let responseMessage = document.getElementById('errormessage');

            fetch(`/api/users/check-username?username=${username}`)
                .then(response => {
                    if(!response.ok){
                        // 응답이 ok가 아니면 텍스트로 에러 메시지를 읽는다 -> rest api에서 에러 처리부분
                        // 에러를 Error 객체로 감싸서 throw하면 catch 블록에서 error.message를 통해 해당 에러 메시지를 받을 수 있다.
                        return response.text().then(errorMessage => { throw new Error(errorMessage) });
                    }
                    return   response.json(); // 서버에서 받은 응답이 ok라면  JSON 데이터를 파싱하여 JavaScript 객체로 반환
                })
                .then(data => {
                    console.log(data);
                    // JSON 객체에 exists 값이 false라면 중복이 없는것.
                    // 중복된 것은 api에서 에러로 처리하여 catch 블록에서 처리할 것
                    if (!data.exists) {
                        responseMessage.value = 'true';
                        alert('해당 아이디는 사용가능합니다.');
                    }
                })
                .catch(error => {
                    responseMessage.value = error.message;
                    alert('해당 아이디는 이미 존재합니다.  ' + error.message);
                });
        });
        form.submit(); // 폼 제출
    });
</script>
</body>
</html>